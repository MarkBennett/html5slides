<!DOCTYPE html>
<html>
  <head>
    <title>Interacting with Web Content using the Mozilla Add-on SDK</title>

    <meta charset='utf-8'>
    <script src="slides.js"></script>
  </head>
    <body style='display: none'>

    <section class='slides layout-regular template-default'>
      
<article>
  <h1>Interacting with <br/>Web Content</h1>
  <h3>Mozilla Add-on SDK Workshop</h3>
</article>

<article>
  <h1>Follow along</h1>
  <h3><a href="http://talks.canuckistani.ca/webcontent-uk-2011">http://talks.canuckistani.ca/webcontent-uk-2011</a></h3>
</article>

<article>
  <h3>Content scripts</h3>
  <ul class="build">
   <li>inject any JavaScript logic into a page:
    <ul>
      <li>inline JS code</li>
      <li>your own scripts and libraries</li>
      <li>3rd party JS libraries such as jQuery</li>
    </ul>
   </li>
   <li>modify the page's DOM</li>
   <li>communicate from the content script back to your add-on code</li>
  </ul>
</article>
   
<article>
  <h3>Hello, world</h3>
  <pre>var pageMod = require("page-mod").PageMod({
  include: ['*'],
  contentScript: 'alert("Heellooooooo, Looondoooon!!!!")',
  contentScriptWhen: 'end',
});</pre>
  
<div style="margin-top: 0;" class="build">
  <h3>Dissection:</h3>
</div>
  <ul class="build">
    <li><code>include: ['*']</code> which site(s) do we mod?</li>
    <li><code>contentScript</code> JS code to run.</li>
    <li><code>contentScriptWhen: 'ready'</code> when to run the code.</li>
  </ul>
  
  <a href="https://builder.addons.mozilla.org/addon/1018002/revision/2/">Link</a>
</article>

<article>
  <h3>Content script security model</h3>
  <ul class="build">
    <li><code>window</code> object is actually a proxy to the page's window.</li>
    <li>JS running in the page cannot change anything the content script has access to.</li>
  </ul>
  
<div style="margin-top: 0;" class="build">
  <div>
    <p style="margin: 0 0 20px 0;">Example</p>
    <p>Page script:
      <pre style="margin: 6px 0 20px 0;">window.alert = function(arg) { /* evil code here */ }</pre></p>
    
      <p>Content script:
      <pre style="margin: 6px 0 20px 0;">window.alert("Heellooooooo, Looondoooon!!!!");</pre></p>
    
      <a href="https://builder.addons.mozilla.org/addon/1017986/revision/25/">Link</a>
    
      <p>Result?</p>
  </div>
</div>
</article>

<article>
  <h3>workaround: unsafeWindow</h3>
  
  <p><code>unsafeWindow</code>: direct access to the document from content script.
  This is a security hole, here be dragons, this will steal your lunch, etc.</p>
  
  <p>Using previous example, if you change the content script to:</p>
  
  <p>Content script:
  <pre style="margin: 6px 0 20px 0;">unsafeWindow.alert("Heellooooooo, Looondoooon!!!!");</pre></p>
  
  <p>Result: Hodor!!!</p>
  
</article>

<article>
  <h1>Exercise 1:</h1>
  <p>Expand the 'hello world' example to do something funny / evil / useful to every page.</p>
  <p> <a href="https://builder.addons.mozilla.org/addon/1018002/revision/2/">Builder link</a>, or</p>
  <p><code>webcontent/1-hello</code> in the github repo</p>
</article>

<article>
  <h3>page-mod</h3>
  <ul class="build">
    <li><code>['*']</code>: target any document loaded</li>
    <li>target very specific urls: <br/><code>['http://canuckistani.ca/some_page.html']</code></li>
    <li>execute on start, ready or end ( default )</li>
    <li>react to the 'content script attached' event using onAttach</li>
    <li>emit events into your content scripts via a worker</li>
    <li>drawback: loaded into any matching document, including iframes!</li>
  </ul>
</article>

<article>
  <h3>'Batteries included' example</h3>
  <pre>var pageMod = require("page-mod").PageMod({
    include: ['*.canuckistani.ca'],
    contentScriptWhen: 'end',
    contentScriptFile: [data.url('lib.js')],
    onAttach: function(worker) {
      workers.push(worker);
      worker.on('detach', function () {
        detachWorker(this, workers);
      });
      worker.postMessage('42'); 
    }
  });</pre>
  <a target="_blank" href="https://builder.addons.mozilla.org/addon/1015111/latest/">Link</a>
</article>

<article>
  <h1>Exercise 2:</h1>
  <ul>
    <li>use <a href="https://builder.addons.mozilla.org/addon/1017561/revision/5/">
    this example</a> to start<br/> ( or webcontent/2-pagemod in the git repo )</li>
    <li>target a specific site and up / degrade it's usability</li>
    <li>note: blanking out the page is too easy...</li>
    <li>be creative!</li>
  </ul>
</article>

<article>
  <h3>tabs</h3>
  <ul>
    <li>tabs:
      <ul>
        <li>utilities for opening & closing tabs</li>
        <li>tabs meta-data: title, url, etc.</li>
        <li>react to tab-related events: open, close, ready, activate, deactivate</li>
        <li>content scripts are loaded into the tab's <em>top-level</em> content.</li>
      </ul>
    </li>
  </ul>
</article>

<article>
  <h3>Tabs / onAttach example</h3>
  <pre>var data = require("self").data;
var tabs = require("tabs");
 
tabs.on('ready', function(tab) {
  tab.attach({
  contentScript: 'if (confirm("EXTERMINATE???")) ' + 
    '{ document.body.innerHTML = ' +
    '\'&lt;img src=&quot;http://dailypop.files.wordpress.com/2010/04/dalek.gif&quot;&gt;\';' + 
    'document.body.style.display="block"; ' + 
    '};',
  });
});</pre>
  
<a href="https://builder.addons.mozilla.org/addon/1016218/revision/7/">Link</a>
</article>

<article>
  <h3>Exercise 3.a</h3>
  <ul>
    <li>Use the tab onAttach example <a href="https://builder.addons.mozilla.org/addon/1016218/revision/7/">here</a></li>
    <li>Implement some behaviour based on a different tab event.</li>
  </ul>
  
  <h3>Exercise 3.b</h3>
  <ul>
    <li>Use the same <a href="https://builder.addons.mozilla.org/addon/1016218/revision/7/">example</a></li>
    <li>adjust the behaviour so that the confirm dialog only pops up on mozilla.org.</li>
  </ul>
</article>

<article>
  <h1>Content script communications</h1>
  <ul>
    <li>add-on code <==> content script</li>
    <li>content script ==> page</li>
    <li>content script <== page</li>
  </ul>
</article>

<article>
  <h3>Example: posting a message to a content script.</h3>
  <p style="margin: 0 0 20px 0;">Example</p>
    <p>Add-on code:
      <pre style="margin: 6px 0 20px 0;">onAttach: function(worker) {
  workers.push(worker);
  worker.on('detach', function () {
    detachWorker(this, workers);
  });
  worker.postMessage('42');
}</pre></p>
      <p>Content script:
      <pre style="margin: 6px 0 20px 0;">self.on('message', function (payload) {
    window.alert('The answer to the ultimate question of life, the universe ' + "\n" +
      'and everything is '+parseInt(payload));
});</pre></p>
      
    <a href="https://builder.addons.mozilla.org/addon/1018008/revision/12/">Link</a>
</article>

<article>
  <h3>Example: posting a message from a content script to your add-on.</h3>
  <p style="margin: 0 0 20px 0;">Example</p>
    <p>Content script:
      <pre style="margin: 6px 0 20px 0;">self.postMessage("This is from the content script!");</pre></p>
      <p>Add-on code:
      <pre style="margin: 6px 0 20px 0;">worker.on("message", function(data) {
    console.log("Got message: " + data);
})</pre></p>
      
    <a href="https://builder.addons.mozilla.org/addon/1018008/revision/45/">Link</a>
</article>

<article>
  <h3>Example: posting a message from a content script to a page.</h3>
  <p style="margin: 0 0 20px 0;">Example</p>
    <p>Content script:
      <pre style="margin: 6px 0 20px 0;">document.defaultView.postMessage(' +
        '"this is my message...", "*");</pre></p>
      <p>Page code:
      <pre style="margin: 6px 0 20px 0;">window.addEventListener('message', function(e) {
    console.log("Got message: " + e.data);
});</pre></p>
      
    <a href="https://builder.addons.mozilla.org/addon/1017541/revision/5/">Link</a>
</article>

<article>
  <h3>Example: posting a message from a page to your content script.</h3>
  <p style="margin: 0 0 20px 0;">Example</p>
    <p>Page script:
      <pre style="margin: 6px 0 20px 0;">$(document).ready(function() {
    $("#clicker").click(function() {
        window.postMessage("sending message from page!", "*");
        return false;
    });
});</pre></p>
      <p>Add-on code:
<pre style="margin: 6px 0 20px 0;">
tab.attach({
  contentScript: 'window.addEventListener("message",
    function(ev) {
      alert("In content script, got "+ ev.data);',
});
</pre></p>      
  <a href="https://builder.addons.mozilla.org/addon/1017544/revision/50/">Link</a>
</article>

<article>
  <h1>Exercise 4</h1>
  <p>Using <a href="https://builder.addons.mozilla.org/addon/1017544/revision/50/">this example</a> as a starting point, implement
  a button in a page that sends an message through to your add-on code in main.js.</p>
</article>

<article>
  <h1>Questions?</h1>
</article>

<article>
  <h1>We are all Rocketeers!</h1>
</article>

<article>
  <h3>Get involved, kick the tires, let us know.</h3>
  <ul>
    <li>IRC: #jetpack</li>
    <li><a href="http://groups.google.com/group/mozilla-labs-jetpack">Google Group</a></li>
    <li><a href="https://forums.mozilla.org/addons/viewforum.php?f=27">AMO Forum</a></li>
    <li><a href="https://wiki.mozilla.org/Jetpack#Weekly_Meeting">Weekly project meetings</a></li>
    <li><a href="http://stackoverflow.com/questions/tagged/jetpack">Stack Overflow</a></li>
  </ul>
</article>
</body>
</html>
